<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3e2723">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Ø¯Ø§Ù…Ø§ Ù…ØºØ±Ø¨ÙŠØ© Ø¨Ø±Ùˆ</title>

    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Dama%20Morocco%22,%22short_name%22:%22Dama%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#121212%22,%22theme_color%22:%22#3e2723%22}">

    <style>
        :root { --wood:#3e2723; --dark:#5d3a2a; --light:#e0c091; --gold:#f1c40f; }
        *{box-sizing:border-box;user-select:none;-webkit-tap-highlight-color:transparent}
        body{margin:0;background:#121212;color:#fff;font-family:sans-serif;
        display:flex;flex-direction:column;height:100vh;text-align:center; overflow: hidden;}

        .header{background:#1e1e1e;padding:10px;border-bottom:3px solid #333; flex-shrink: 0;}
        .score-board{display:flex;justify-content:space-around;margin-top:5px}
        .score-item{background:#2c2c2c;padding:6px 14px;border-radius:12px;border:1px solid #444}
        .score-val{color:var(--gold);font-weight:bold}

        .board-container{flex:1;display:flex;justify-content:center;align-items:center;padding:10px; touch-action: pinch-zoom;}
        .board{
            display:grid;grid-template-columns:repeat(8,1fr);
            width:95vw;height:95vw;max-width:460px;max-height:460px;
            border:10px solid var(--wood);background:var(--wood);
            box-shadow:0 15px 50px rgba(0,0,0,.9); border-radius: 8px;
            touch-action: none;
        }

        .cell{display:flex;align-items:center;justify-content:center}
        .dark{background:var(--dark)}
        .light{background:var(--light)}

        .piece{
            width:84%;height:84%;border-radius:50%;
            box-shadow:inset 0 -4px 6px rgba(0,0,0,.4),0 5px 10px rgba(0,0,0,.5);
            transition:.18s;position:relative; z-index: 2;
        }
        .white{background:radial-gradient(circle at 35% 35%,#fff,#ccc); border: 1px solid #999;}
        .black{background:radial-gradient(circle at 35% 35%,#444,#000); border: 1px solid #222;}

        .king::after{
            content:"ğŸ‘‘";position:absolute;top:50%;left:50%;
            transform:translate(-50%,-50%);font-size:1.4rem; filter: drop-shadow(0 2px 2px #000);
        }

        .selected{transform:scale(1.15); border: 3px solid var(--gold) !important; box-shadow: 0 0 15px var(--gold);}
        .must-capture{ animation: pulse 1s infinite; border: 2px solid #e74c3c !important; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }

        #overlay{
            display:none;position:fixed;inset:0;background:rgba(0,0,0,.95);
            z-index:1000;flex-direction:column;justify-content:center;align-items:center
        }
        .btn{
            padding:15px 35px;border-radius:30px;background:#c0392b;
            border:none;color:white;font-weight:bold;font-size:1.2rem; cursor: pointer;
        }
        
        /* Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #installBtn {
            display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--gold); color: #000; padding: 10px 20px; border-radius: 20px;
            font-weight: bold; z-index: 999; border: none; cursor: pointer;
        }
    </style>
</head>
<body>

    <button id="installBtn">ØªØ«Ø¨ÙŠØª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ</button>

    <div class="header">
        <div id="status">Ø§Ù„Ø¯Ø§Ù…Ø§ Ø§Ù„Ù…ØºØ±Ø¨ÙŠØ© â€” Ø¯ÙˆØ±Ùƒ</div>
        <div class="score-board">
            <div class="score-item">Ø£Ù†Øª <span id="pScore" class="score-val">0</span></div>
            <div class="score-item">Ø§Ù„Ø¨ÙˆØª <span id="bScore" class="score-val">0</span></div>
        </div>
    </div>

    <div class="board-container">
        <div id="board" class="board"></div>
    </div>

    <div id="overlay">
        <h2 id="winnerText" style="color:var(--gold); font-size: 2rem; margin-bottom: 20px;"></h2>
        <button class="btn" onclick="resetGame()">Ù„Ø¹Ø¨ Ù…Ù† Ø¬Ø¯ÙŠØ¯</button>
    </div>

<script>
    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù€ PWA Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† ÙƒØ±ÙˆÙ… ---
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installBtn').style.display = 'block';
    });

    document.getElementById('installBtn').addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                document.getElementById('installBtn').style.display = 'none';
            }
            deferredPrompt = null;
        }
    });

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù†ÙØ³ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ) ---
    const boardEl = document.getElementById("board");
    const statusEl = document.getElementById("status");
    const pScoreEl = document.getElementById("pScore");
    const bScoreEl = document.getElementById("bScore");

    let board, turn, selected, mandatory, multiJump, lock;
    let pScore = parseInt(localStorage.getItem('pScore')) || 0;
    let bScore = parseInt(localStorage.getItem('bScore')) || 0;
    pScoreEl.textContent = pScore; bScoreEl.textContent = bScore;

    const dark = i => ((Math.floor(i/8)+i%8)%2===1);
    const rc = i => [Math.floor(i/8), i%8];
    const idx = (r,c)=> r*8+c;

    function initBoard(){
        board = Array(64).fill(null);
        for(let i=0;i<64;i++){
            if(!dark(i)) continue;
            let r=Math.floor(i/8);
            if(r<3) board[i]={color:"bot", king:false};
            if(r>4) board[i]={color:"player", king:false};
        }
    }

    function start(){
        initBoard(); turn="player"; selected=null; mandatory=[]; multiJump=false; lock=false;
        findMandatory(); render();
    }

    function render(){
        boardEl.innerHTML="";
        for(let i=0;i<64;i++){
            let cell=document.createElement("div");
            cell.className="cell "+(dark(i)?"dark":"light");
            if(board[i]){
                let p=document.createElement("div");
                p.className="piece "+(board[i].color==="player"?"white":"black");
                if(board[i].king) p.classList.add("king");
                if(selected===i) p.classList.add("selected");
                if(turn==="player" && mandatory.some(m=>m.from===i)) p.classList.add("must-capture");
                cell.appendChild(p);
            }
            cell.onclick=()=>onClick(i);
            boardEl.appendChild(cell);
        }
    }

    function validate(from,to,color){
        if(to<0 || to>63 || board[to] || !dark(to)) return null;
        let p=board[from];
        if(!p || p.color!==color) return null;
        let [r1,c1]=rc(from), [r2,c2]=rc(to);
        let dr=r2-r1, dc=Math.abs(c2-c1);
        if(Math.abs(dr)!==dc) return null;
        let sR=Math.sign(dr), sC=Math.sign(c2-c1), dist=Math.abs(dr);

        if(!p.king){
            if(dist===1 && !multiJump && (color==="player"?dr===-1:dr===1)) return {from,to};
            if(dist===2){
                let m=idx(r1+sR,c1+sC);
                if(board[m] && board[m].color!==color) return {from,to,cap:m};
            }
        } else {
            let cap=null, cnt=0;
            for(let s=1; s<dist; s++){
                let i=idx(r1+s*sR,c1+s*sC);
                if(board[i]){ if(board[i].color===color) return null; cap=i; cnt++; }
            }
            if(cnt===0 && !multiJump) return {from,to};
            if(cnt===1) return {from,to,cap};
        }
        return null;
    }

    function findMandatory(){
        mandatory = [];
        for(let i=0; i<64; i++){
            if(board[i] && board[i].color===turn){
                for(let t=0; t<64; t++){
                    let m=validate(i,t,turn);
                    if(m && m.cap!==undefined) mandatory.push(m);
                }
            }
        }
    }

    function onClick(i){
        if(lock || turn!=="player") return;
        if(board[i] && board[i].color==="player"){
            if(multiJump && selected!==i) return;
            if(mandatory.length && !mandatory.some(m=>m.from===i)) return;
            selected=i; render();
        } else if(selected!==null){
            let m=validate(selected,i,"player");
            if(mandatory.length && (!m || m.cap===undefined)) return;
            if(m){
                execMove(m);
                if(m.cap!==undefined && hasCap(m.to,"player")){
                    multiJump=true; selected=m.to; findMandatory(); statusEl.textContent="ÙƒÙ…Ù‘Ù„ Ø§Ù„Ø£ÙƒÙ„!"; render();
                } else {
                    multiJump=false; turn="bot"; lock=true; render(); setTimeout(botTurn,600);
                }
            }
        }
    }

    function execMove(m){
        board[m.to]=board[m.from]; board[m.from]=null;
        if(m.cap!==undefined) board[m.cap]=null;
        let [r2]=rc(m.to);
        if((board[m.to].color==="player" && r2===0) || (board[m.to].color==="bot" && r2===7)) board[m.to].king=true;
        selected=null;
    }

    function hasCap(f,c){
        for(let t=0; t<64; t++){ let m=validate(f,t,c); if(m && m.cap!==undefined) return true; }
        return false;
    }

    function botTurn(){
        findMandatory();
        let moves = mandatory.length ? mandatory : [];
        if(!moves.length){
            for(let i=0; i<64; i++) if(board[i] && board[i].color==="bot") 
                for(let t=0; t<64; t++){ let m=validate(i,t,"bot"); if(m) moves.push(m); }
        }
        if(!moves.length){ endGame("ØªØ¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙƒØŒ Ø±Ø¨Ø­ØªÙŠ!"); return; }
        let m = moves[Math.floor(Math.random()*moves.length)];
        execMove(m);
        if(m.cap!==undefined && hasCap(m.to,"bot")){ setTimeout(botTurn,400); return; }
        turn="player"; lock=false; findMandatory(); statusEl.textContent="Ø¯ÙˆØ±Ùƒ"; render();
        if(!mandatory.length && !moves.length) checkEnd();
    }

    function checkEnd(){
        let p=0, b=0; board.forEach(x=>{if(x){if(x.color==="player")p++; else b++;}});
        if(!p) endGame("Ø§Ù„Ø¨ÙˆØª Ø±Ø¨Ø­Ùƒ!"); if(!b) endGame("Ù†ØªØ§ Ù„ÙŠ Ø±Ø¨Ø­ØªÙŠ!");
    }

    function endGame(msg){
        document.getElementById("winnerText").textContent=msg;
        document.getElementById("overlay").style.display="flex";
        if(msg.includes("Ù†ØªØ§")) { pScore++; localStorage.setItem('pScore', pScore); } else { bScore++; localStorage.setItem('bScore', bScore); }
        pScoreEl.textContent=pScore; bScoreEl.textContent=bScore;
    }

    function resetGame(){ document.getElementById("overlay").style.display="none"; start(); }
    start();
</script>
</body>
</html>
